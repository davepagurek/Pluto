var request = require('popsicle');
var Levenshtein = require("levenshtein");
module.exports = {
<<<<<<< HEAD
  getLink: function(song, index , callback){
    request('http://muzik.elasticbeanstalk.com/search?songname='+ song.name.shellEscape() + " " + song.artist.shellEscape())
    .then(function(res){
      var body = JSON.parse(res.body);
      var urls = body.url;
      var firstResult = urls[index];
      var url = firstResult[Object.keys(firstResult)[0]];
      callback(Object.keys(firstResult)[0],url);
    });
  }
=======
    getLink: function (song,ignore,callback){
        request('http://muzik.elasticbeanstalk.com/search?songname='+ song.name + " " + song.artist)
        .then(function(res){
            var body = JSON.parse(res.body);
            var urls = body.url;
            var result = _.min(_.filter(urls, function(element) {
                var url = element[Object.keys(element)[0]];
                return !!url.match(/\.mp3$/) &&
                    ignore.indexOf(url) == -1;
            }), function(element) {
                return new Levenshtein(song.name, Object.keys(element)[0]).distance;
            });
            var url = result[Object.keys(result)[0]];
            callback(Object.keys(result)[0],url);
        });
    }
>>>>>>> cc04b010aab4f0219ac6908857e99e2eddc3df50
}
